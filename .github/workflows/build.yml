name: Build and Release

# Workflow for building and releasing StageForge application packages
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build (all, full, obs, libreoffice, core)'
        required: false
        default: 'all'

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 0: CodeQL Security Check (must pass before building)
  codeql-check:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # Job 1: Build Windows variants
  build-windows:
    name: Build Windows (${{ matrix.edition }})
    runs-on: windows-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prepare Gothic fonts
        shell: pwsh
        run: |
          Write-Host "Preparing Gothic fonts for Windows build..."
          New-Item -Path "src/renderer/fonts" -ItemType Directory -Force
          Write-Host "Fonts will be downloaded via npm prebuild script"

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        shell: pwsh
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS portable
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        shell: pwsh
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice portable
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        shell: pwsh
        run: |
          $edition = "${{ matrix.edition }}"
          echo "EDITION=$edition" >> $env:GITHUB_ENV
          '{"edition": "' + $edition + '"}' | Out-File -FilePath edition.json -Encoding utf8

      - name: Build Windows package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Windows-x64
          path: dist/*.exe
          retention-days: 30

  # Job 2: Build macOS variants
  build-macos:
    name: Build macOS (${{ matrix.edition }})
    runs-on: macos-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prepare Gothic fonts
        run: |
          echo "Preparing Gothic fonts for macOS build..."
          chmod +x build/scripts/prepare-fonts.sh
          bash build/scripts/prepare-fonts.sh || echo "Font download skipped (will use system fonts as fallback)"

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Check if certificate secrets are available
          if [ -z "$MACOS_CERTIFICATE" ] || [ -z "$MACOS_CERTIFICATE_PWD" ]; then
            echo "Code signing certificate not available (secrets not set)"
            echo "Build will continue without code signing"
            exit 0
          fi
          
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Import certificate from secrets (decode directly to file)
          echo "$MACOS_CERTIFICATE" | base64 --decode > "$CERTIFICATE_PATH"

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate to keychain
          security import "$CERTIFICATE_PATH" -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Verify certificate
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          
          echo "Code signing certificate imported successfully"

      - name: Configure build environment
        run: |
          # Set environment variables for code signing based on certificate availability
          # The import step only runs if certificate exists, so check for the file
          if [ -f "$RUNNER_TEMP/build_certificate.p12" ]; then
            echo "CSC_LINK=$RUNNER_TEMP/build_certificate.p12" >> $GITHUB_ENV
            echo "CSC_KEY_PASSWORD=${{ secrets.MACOS_CERTIFICATE_PWD }}" >> $GITHUB_ENV
            echo "Code signing is enabled"
          else
            echo "CSC_IDENTITY_AUTO_DISCOVERY=false" >> $GITHUB_ENV
            echo "Code signing is disabled (no certificate provided)"
          fi

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS for macOS
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice for macOS
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        run: |
          echo "EDITION=${{ matrix.edition }}" >> $GITHUB_ENV
          echo '{"edition": "${{ matrix.edition }}"}' > edition.json

      - name: Build macOS package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build

      - name: Cleanup mounted volumes
        if: always()
        run: |
          echo "Checking for and cleaning up any mounted DMG volumes..."
          # Get product name from electron-builder config
          PRODUCT_NAME=$(node -e "console.log(require('./electron-builder.json').productName)")
          
          # List all mounted volumes
          ls -la /Volumes/ || true
          
          # Try to detach any product volumes if they exist
          # Escape the product name for safe use in regex
          # Put ] at beginning of character class to match it literally
          ESCAPED_NAME=$(printf '%s\n' "$PRODUCT_NAME" | sed 's/[][\/$*.^]/\\&/g')
          
          # Match volumes that start with the product name (may have version numbers)
          # Use find and filter with grep to properly handle volume names with spaces
          find /Volumes -maxdepth 1 -type d 2>/dev/null | grep -E "^/Volumes/${ESCAPED_NAME}" | while read -r volume; do
            if [ -d "$volume" ]; then
              echo "Found mounted volume: $volume"
              hdiutil detach "$volume" -quiet -force || echo "Could not detach $volume (may already be detached)"
            fi
          done
          
          echo "Cleanup completed."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-macOS
          path: dist/*.dmg
          retention-days: 30

  # Job 3: Build Linux variants
  build-linux:
    name: Build Linux (${{ matrix.edition }})
    runs-on: ubuntu-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Prepare Gothic fonts
        run: |
          echo "Preparing Gothic fonts for Linux build..."
          chmod +x build/scripts/prepare-fonts.sh
          bash build/scripts/prepare-fonts.sh || echo "Font download skipped (will use system fonts as fallback)"

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS portable for Linux
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice portable for Linux
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        run: |
          echo "EDITION=${{ matrix.edition }}" >> $GITHUB_ENV
          echo '{"edition": "${{ matrix.edition }}"}' > edition.json

      - name: Build Linux package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build

      - name: Upload AppImage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Linux-x64-AppImage
          path: dist/*.AppImage
          retention-days: 30

      - name: Upload tar.gz artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Linux-x64-tar
          path: dist/*.tar.gz
          retention-days: 30

  # Job 4: Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
