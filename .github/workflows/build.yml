name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build (all, full, obs, libreoffice, core)'
        required: false
        default: 'all'

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 0: CodeQL Security Check (must pass before building)
  codeql-check:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # Job 1: Build Windows variants
  build-windows:
    name: Build Windows (${{ matrix.edition }})
    runs-on: windows-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        shell: pwsh
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS portable
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        shell: pwsh
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice portable
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        shell: pwsh
        run: |
          $edition = "${{ matrix.edition }}"
          echo "EDITION=$edition" >> $env:GITHUB_ENV
          '{"edition": "' + $edition + '"}' | Out-File -FilePath edition.json -Encoding utf8

      - name: Build Windows package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Windows-x64
          path: dist/*.exe
          retention-days: 30

  # Job 2: Build macOS variants
  build-macos:
    name: Build macOS (${{ matrix.edition }})
    runs-on: macos-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS for macOS
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice for macOS
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        run: |
          echo "EDITION=${{ matrix.edition }}" >> $GITHUB_ENV
          echo '{"edition": "${{ matrix.edition }}"}' > edition.json

      - name: Build macOS package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-macOS
          path: dist/*.dmg
          retention-days: 30

  # Job 3: Build Linux variants
  build-linux:
    name: Build Linux (${{ matrix.edition }})
    runs-on: ubuntu-latest
    needs: codeql-check
    permissions:
      contents: read
    strategy:
      matrix:
        edition: [Full, OBS, LibreOffice, Core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Download OBS runtime (Full & OBS editions)
        if: matrix.edition == 'Full' || matrix.edition == 'OBS'
        run: |
          mkdir -p resources/obs
          # Placeholder: Download OBS portable for Linux
          echo "OBS runtime would be downloaded here" > resources/obs/README.txt

      - name: Download LibreOffice runtime (Full & LibreOffice editions)
        if: matrix.edition == 'Full' || matrix.edition == 'LibreOffice'
        run: |
          mkdir -p resources/libreoffice
          # Placeholder: Download LibreOffice portable for Linux
          echo "LibreOffice runtime would be downloaded here" > resources/libreoffice/README.txt

      - name: Create edition marker
        run: |
          echo "EDITION=${{ matrix.edition }}" >> $GITHUB_ENV
          echo '{"edition": "${{ matrix.edition }}"}' > edition.json

      - name: Build Linux package
        env:
          EDITION: ${{ matrix.edition }}
        run: npm run build

      - name: Upload AppImage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Linux-x64-AppImage
          path: dist/*.AppImage
          retention-days: 30

      - name: Upload tar.gz artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StageForge-${{ matrix.edition }}-Linux-x64-tar
          path: dist/*.tar.gz
          retention-days: 30

  # Job 4: Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
